# í•˜ì´ë‹‰ìŠ¤ OLTP Mart ê¸°ë°˜ Text2SQL ì—ì´ì „íŠ¸ ì„¤ê³„ ë¬¸ì„œ v2

> **ë³€ê²½ ì´ë ¥**
> - v2.4 (2026-01-08): Multi-Fab UNION ALL íŒ¨í„´ ì§€ì› ì¶”ê°€, fab_idë¥¼ fab_ids ë¦¬ìŠ¤íŠ¸ë¡œ í™•ì¥
> - v2.3 (2026-01-08): Chainlit ì±„íŒ… UI ë° Multiturn ì§€ì› ì¶”ê°€, Google A2A í”„ë¡œí† ì½œ ë„ì…
> - v2.2 (2026-01-06): LangChain 1.x create_agent API ê¸°ë°˜ êµ¬í˜„ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜, Tool ì •ì˜ ì¶”ê°€
> - v2.1 (2026-01-05): í…Œì´ë¸” suffix ê·œì¹™ ìƒì„¸í™” (Site/Fab ID, ê³µì • suffix), í‘œì¤€ ë‹¨ì–´ì‚¬ì „ ì„¹ì…˜ ì¶”ê°€
> - v2 (2026-01-04): êµ¬ì¡° ê°œì„ , Mermaid ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€, ì„¸ë¶€ì‚¬í•­ êµ¬ì²´í™”

---

## ğŸ“Œ ê°œìš”

í•˜ì´ë‹‰ìŠ¤ OLTP Mart ê¸°ë°˜ Text2SQL ì—ì´ì „íŠ¸ëŠ” **2ë‹¨ê³„ ì—ì´ì „íŠ¸ íŒŒì´í”„ë¼ì¸**ìœ¼ë¡œ ì„¤ê³„í•œë‹¤:

1. **1ë‹¨ê³„**: ìƒ˜í”Œ SQL ê¸°ë°˜ ìœ ì‚¬ ì§ˆì˜ ì¶”ì²œ
2. **2ë‹¨ê³„**: ì „ë¬¸ê°€ ì‚¬ê³ ê³¼ì • ëª¨ì‚¬ Text2SQL

```mermaid
flowchart LR
    subgraph Stage1["1ë‹¨ê³„: ìœ ì‚¬ SQL ê¸°ë°˜"]
        S1A[ì§ˆì˜ ì •ì œ] --> S1B[ë²¡í„° ê²€ìƒ‰]
        S1B --> S1C[í…œí”Œë¦¿ ì„ íƒ/ìˆ˜ì •]
    end
    
    subgraph Stage2["2ë‹¨ê³„: ì „ë¬¸ê°€ ëª¨ì‚¬"]
        S2A[ì˜ë„ êµ¬ì¡°í™”] --> S2B[ìŠ¤í‚¤ë§ˆ RAG]
        S2B --> S2C[SQL ìƒì„±]
        S2C --> S2D[ê²€ì¦/ì‹œë®¬ë ˆì´ì…˜]
    end
    
    User([ì‚¬ìš©ì ì§ˆì˜]) --> Stage1
    Stage1 -->|ìœ ì‚¬ë„ ì¶©ì¡±| Execute[SQL ì‹¤í–‰]
    Stage1 -->|ìœ ì‚¬ë„ ë¯¸ë‹¬| Stage2
    Stage2 --> Execute
    Execute --> Response([ê²°ê³¼ ì‘ë‹µ])
```

---

## 1. ì „ì²´ ëª©í‘œì™€ ì „ì œ

### 1.1 ëŒ€ìƒ ì‹œìŠ¤í…œ

| í•­ëª© | ìƒì„¸ |
|------|------|
| **ëŒ€ìƒ DB** | í•˜ì´ë‹‰ìŠ¤ ìƒì‚° OLTP Mart |
| **íŠ¹ì§•** | ìˆ˜ë§ì€ í…Œì´ë¸”, ë¹„ì •í˜• ì»¬ëŸ¼ëª…, ì™¸ë˜í‚¤ ê±°ì˜ ì—†ìŒ |
| **í…Œì´ë¸” ë„¤ì´ë° ê·œì¹™** | í…Œì´ë¸”ëª…ì€ suffixë¡œ `fab_id` ë˜ëŠ” `site_id+ê³µì •ëª…` ì¡°í•©ì„ ì‚¬ìš© |
| **Site ì¢…ë¥˜** | IC (ì´ì²œ), CJ (ì²­ì£¼), WX (ìš°ì‹œ) |
| **Fab ID (Siteë³„)** | ì´ì²œ: M10, M14, M16, R3, WLP / ì²­ì£¼: M11, M15, WLP3 / ìš°ì‹œ: C2 |

#### í…Œì´ë¸” Suffix ê·œì¹™

í…Œì´ë¸”ëª…ì˜ suffixëŠ” ë‘ ê°€ì§€ ìœ í˜•ìœ¼ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤:

| Suffix ìœ í˜• | í˜•ì‹ | ì˜ˆì‹œ |
|-------------|------|------|
| **ìœ í˜• 1** | fab_idë§Œ ì‚¬ìš© | `MES_BIZ_LOTHOLD_INF_M10`, `MES_BIZ_LOTHOLD_INF_M14` |
| **ìœ í˜• 2** | site_id + ê³µì •ëª… ì¡°í•© | `MES_BIZ_LOTHOLD_INF_ICWT`, `MES_BIZ_LOTHOLD_INF_CJPNT` |

**ê³µì • Suffix ì˜ˆì‹œ**:

| Suffix | Site | ê³µì •ëª… | ì„¤ëª… |
|--------|------|--------|------|
| ICWT | IC | ì›¨ì´í¼ í…ŒìŠ¤íŠ¸ | ì´ì²œ ì›¨ì´í¼ í…ŒìŠ¤íŠ¸ ê³µì • |
| CJRNDWT | CJ | R&D ì›¨ì´í¼ í…ŒìŠ¤íŠ¸ | ì²­ì£¼ ì—°êµ¬ê°œë°œ ì›¨ì´í¼ í…ŒìŠ¤íŠ¸ |
| CJPNT | CJ | íŒ¨í‚¤ì§• AND í…ŒìŠ¤íŠ¸ | ì²­ì£¼ íŒ¨í‚¤ì§• AND í…ŒìŠ¤íŠ¸ ê³µì • |

> **ì˜ˆì‹œ í…Œì´ë¸”**: `MES_BIZ_LOTHOLD_INF_XXX`
> - **ì„¤ëª…**: ê³µì • ì§„í–‰ ì¤‘ì¸ ë¡œíŠ¸(lot)ì— hold ì›ì¸ì´ ë°œìƒí•œ ê²ƒì— ëŒ€í•œ ì²˜ë¦¬ì™€ ë¶„ì„ ì •ë³´ ê´€ë¦¬
> - XXXëŠ” ìœ„ì˜ suffix ê·œì¹™ì— ë”°ë¼ `M10`, `ICWT` ë“±ìœ¼ë¡œ ëŒ€ì²´ë¨

#### Multi-Fab UNION ALL íŒ¨í„´

ì—¬ëŸ¬ Fabì˜ ë°ì´í„°ë¥¼ ë™ì‹œì— ì¡°íšŒí•  ë•Œ **UNION ALL íŒ¨í„´**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:

```sql
-- M10, M11, M14 Fabì˜ ë°ì´í„°ë¥¼ ë™ì‹œì— ì¡°íšŒ
SELECT lot_id, fab_id, create_dt, yield_rate 
FROM MES_PRD_M10 
WHERE create_dt >= :start_date AND create_dt < :end_date
UNION ALL
SELECT lot_id, fab_id, create_dt, yield_rate 
FROM MES_PRD_M11 
WHERE create_dt >= :start_date AND create_dt < :end_date
UNION ALL
SELECT lot_id, fab_id, create_dt, yield_rate 
FROM MES_PRD_M14 
WHERE create_dt >= :start_date AND create_dt < :end_date
```

| íŠ¹ì§• | ì„¤ëª… |
|------|------|
| **ë™ì¼ êµ¬ì¡°** | ëª¨ë“  SELECT ì ˆì˜ ì»¬ëŸ¼ êµ¬ì¡°ê°€ ë™ì¼í•´ì•¼ í•¨ |
| **ë™ì¼ ì¡°ê±´** | WHERE ì¡°ê±´ì€ ëª¨ë“  Fab í…Œì´ë¸”ì— ë™ì¼í•˜ê²Œ ì ìš© |
| **í…œí”Œë¦¿ ì €ì¥** | UNION ALL íŒ¨í„´ì´ í¬í•¨ëœ SQLì„ í•˜ë‚˜ì˜ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥ |
| **Fab ì¡°í•©ë³„** | ìì£¼ ì‚¬ìš©ë˜ëŠ” Fab ì¡°í•©(ì˜ˆ: ì´ì²œ ì „ì²´, Siteë³„ ë“±)ë§ˆë‹¤ ë³„ë„ í…œí”Œë¦¿ ê°€ëŠ¥ |

> **ì°¸ê³ **: Phase 1ì—ì„œëŠ” UNION ALLì´ í¬í•¨ëœ í…œí”Œë¦¿ì„ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ê³  ê²€ìƒ‰í•©ë‹ˆë‹¤.
> Phase 2ì—ì„œëŠ” ë‹¨ì¼ Fab í…œí”Œë¦¿ì—ì„œ ì—¬ëŸ¬ Fab ì¡°í•©ìœ¼ë¡œ ë™ì  í™•ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

### 1.2 ê¸°ìˆ  ìŠ¤íƒ

```mermaid
graph TB
    subgraph UI["UI ë ˆì´ì–´"]
        Chainlit[Chainlit ì±„íŒ… UI]
    end
    
    subgraph Runtime["ëŸ°íƒ€ì„ ë ˆì´ì–´"]
        FastAPI[FastAPI REST API]
        A2AServer[A2A Server]
        LangChain[LangChain 1.x]
        CreateAgent["create_agent API"]
        LangGraph[LangGraph]
    end
    
    subgraph Storage["ì €ì¥ì†Œ ë ˆì´ì–´"]
        Milvus[(Milvus<br/>ë²¡í„° DB)]
        ES[(Elasticsearch 7.x<br/>í‚¤ì›Œë“œ ê²€ìƒ‰)]
        Oracle[(Oracle<br/>ìŠ¤í‚¤ë§ˆ/ë°ì´í„°)]
    end
    
    subgraph LLM["LLM ë ˆì´ì–´"]
        ChatOpenAI[ChatOpenAI]
        InternalLLM[ì‚¬ë‚´ OpenAI í˜¸í™˜ LLM]
        EmbeddingModel[ì„ë² ë”© ëª¨ë¸]
    end
    
    subgraph External["ì™¸ë¶€ ì—ì´ì „íŠ¸"]
        A2AClient[A2A Client]
    end
    
    Chainlit --> LangChain
    A2AClient --> A2AServer
    A2AServer --> LangChain
    FastAPI --> LangChain
    LangChain --> CreateAgent
    CreateAgent --> LangGraph
    LangChain --> ChatOpenAI
    ChatOpenAI --> InternalLLM
    LangChain --> EmbeddingModel
    LangGraph --> Milvus
    LangGraph --> ES
    LangGraph --> Oracle
```

| êµ¬ë¶„ | ê¸°ìˆ  |
|------|------|
| **ì–¸ì–´** | Python 3.10+ |
| **í”„ë ˆì„ì›Œí¬** | LangChain >=1.2.0, LangGraph >=0.2.0 |
| **Agent API** | `create_agent` (LangChain 1.x) |
| **LLM í´ë¼ì´ì–¸íŠ¸** | `langchain_openai.ChatOpenAI` |
| **API** | FastAPI ê¸°ë°˜ REST API |
| **ì±„íŒ… UI** | Chainlit >=1.0.0 (Multiturn ëŒ€í™” ì§€ì›) |
| **ì—ì´ì „íŠ¸ í†µì‹ ** | Google A2A í”„ë¡œí† ì½œ (Agent-to-Agent) |
| **ë²¡í„° DB** | Milvus |
| **ê²€ìƒ‰ ì—”ì§„** | Elasticsearch 7.x (BM25) |
| **ë°ì´í„°ë² ì´ìŠ¤** | Oracle (ìŠ¤í‚¤ë§ˆ/ë°ì´í„° ì €ì¥) |
| **LLM** | ì‚¬ë‚´ ì˜¤í”ˆì†ŒìŠ¤ ëª¨ë¸ (OpenAI í˜¸í™˜ HTTP API) |

### 1.3 ì„¤ê³„ ì›ì¹™

- **POC ìš°ì„ **: ê°„ë‹¨í•œ ì½”ë“œë¡œ ì‹œì‘í•˜ì—¬ ì ì¦ì  êµ¬í˜„
- **ì•ˆì „ì„± ìš°ì„ **: ê²€ì¦ëœ SQL í…œí”Œë¦¿ ìš°ì„  ì‚¬ìš©
- **ê°€ì • ê¸ˆì§€**: í•„ìˆ˜ ì •ë³´ ì—†ì´ LLMì´ ê°€ì •í•˜ì—¬ ì²˜ë¦¬í•˜ëŠ” ê²ƒ ê¸ˆì§€

---

## 2. ì „ì²´ ì•„í‚¤í…ì²˜

```mermaid
graph TB
    subgraph Client["í´ë¼ì´ì–¸íŠ¸"]
        User([ì‚¬ìš©ì])
    end
    
    subgraph API["API ë ˆì´ì–´"]
        FastAPI[FastAPI Server]
    end
    
    subgraph Agents["ì—ì´ì „íŠ¸ ë ˆì´ì–´"]
        QA[Question Agent]
        QueryA[Query Agent]
        AA[Answer Agent]
    end
    
    subgraph Services["ì„œë¹„ìŠ¤ ë ˆì´ì–´"]
        RS[RetrievalService]
        SE[SQLEngineGateway]
        FR[FabIdResolver]
    end
    
    subgraph Data["ë°ì´í„° ë ˆì´ì–´"]
        VDB[(Vector DB)]
        ES[(Elasticsearch)]
        Oracle[(Oracle DB)]
    end
    
    subgraph Offline["ì˜¤í”„ë¼ì¸ íŒŒì´í”„ë¼ì¸"]
        LI[LogIngestor]
        STI[SQLTemplateIndexer]
        SKB[SchemaKnowledgeBuilder]
    end
    
    User --> FastAPI
    FastAPI --> QA
    QA --> QueryA
    QueryA --> AA
    
    QA --> RS
    QueryA --> RS
    QueryA --> SE
    QueryA --> FR
    
    RS --> VDB
    RS --> ES
    SE --> Oracle
    FR --> Oracle
    
    LI --> STI
    STI --> VDB
    SKB --> ES
```

---

## 3. ë°ì´í„° ë ˆì´ì–´ ìƒì„¸

### 3.1 ë©”íƒ€ë°ì´í„° ì¸ë±ìŠ¤ êµ¬ì¡°

#### `meta_schema` ì¸ë±ìŠ¤ (í…Œì´ë¸”/ì»¬ëŸ¼ ìŠ¤í‚¤ë§ˆ)

```json
{
  "object_type": "table | column",
  "db_name": "string",
  "schema_name": "string", 
  "table_name": "string",
  "table_comment": "string",
  "column_name": "string (nullable)",
  "column_comment": "string (nullable)",
  "data_type": "string (nullable)",
  "domain_tags": ["ê³µì •", "ì œí’ˆ", "ì„¤ë¹„"],
  "business_terms": ["string"],
  "updated_at": "datetime"
}
```

#### `meta_glossary` ì¸ë±ìŠ¤ (ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ì „)

```json
{
  "term_id": "string",
  "term_type": "process | product | equipment",
  "term_code": "string",
  "term_name": "string",
  "aliases": ["string"],
  "description": "string",
  "related_tables": ["string"],
  "related_columns": ["string"],
  "business_rules": "string",
  "last_updated_at": "datetime"
}
```

#### `sql_logs` ì¸ë±ìŠ¤ (SQL ë¡œê·¸)

```json
{
  "sql_id": "string",
  "sql_text": "string",
  "sql_text_normalized": "string (ë°”ì¸ë”© ê°’ ì œê±°)",
  "db_name": "string",
  "schema_name": "string",
  "tables": ["string"],
  "columns": ["string"],
  "operation": "SELECT | INSERT | UPDATE | DELETE",
  "created_at": "datetime",
  
  "exec_count": "integer",
  "rows_avg": "float",
  "exec_time_avg_ms": "float",
  "exec_time_p95_ms": "float",
  "last_executed_at": "datetime",
  "error_count": "integer",
  "last_error_at": "datetime",
  
  "business_intent": "string (ì‚¬ëŒì´ ë‹¨ ìš”ì•½)",
  "domain_tags": ["string"],
  "user_group": "string",
  "system_name": "string"
}
```

### 3.2 ê²€ìƒ‰ ì „ëµ

| ëŒ€ìƒ | ê²€ìƒ‰ ë°©ì‹ |
|------|-----------|
| **ìŠ¤í‚¤ë§ˆ** | BM25 í…ìŠ¤íŠ¸ ê²€ìƒ‰ + domain_tags í•„í„°ë§ |
| **ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ì „** | term_code ì •í™• ë§¤ì¹­ ìš°ì„  + multi_match ì¡°í•© |
| **SQL ë¡œê·¸** | business_intent/sql_text_normalized multi_match + exec_count ì •ë ¬ |

### 3.3 í‘œì¤€ ë°ì´í„° ë‹¨ì–´ì‚¬ì „

OLTP Martì—ì„œ ì‚¬ìš©ë˜ëŠ” í‘œì¤€ ë°ì´í„° ë‹¨ì–´ì‚¬ì „ìœ¼ë¡œ, CSV í˜•íƒœë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.

#### ë‹¨ì–´ì‚¬ì „ êµ¬ì¡°

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ë¬¼ë¦¬ëª…** | í…Œì´ë¸”/ì»¬ëŸ¼ì˜ ë¬¼ë¦¬ì  ëª…ì¹­ |
| **ë¬¼ë¦¬ì˜ë¯¸** | ë¬¼ë¦¬ëª…ì˜ ì˜ë¯¸/ì•½ì–´ í’€ì´ |
| **ì„¤ëª…** | ìƒì„¸ ì„¤ëª… ë° ë¹„ì¦ˆë‹ˆìŠ¤ ì»¨í…ìŠ¤íŠ¸ |

#### í™œìš© ìš©ë„

- **í‚¤ì›Œë“œ ê²€ìƒ‰**: ì‚¬ìš©ì ì§ˆì˜ì–´ì™€ ë¬¼ë¦¬ëª…/ë¬¼ë¦¬ì˜ë¯¸ ë§¤ì¹­
- **í…Œì´ë¸”ëª… suffix ì •ë³´ íƒìƒ‰**: suffix ê²°ì •ì— í•„ìš”í•œ ì •ë³´ ì¡°íšŒ
- **ë¹„ì¦ˆë‹ˆìŠ¤ ìš©ì–´ â†” ë¬¼ë¦¬ëª… ë§¤í•‘**: ìì—°ì–´ì™€ DB ìŠ¤í‚¤ë§ˆ ê°„ ì—°ê²°

---

## 4. ì˜¤í”„ë¼ì¸ íŒŒì´í”„ë¼ì¸

```mermaid
flowchart LR
    subgraph Collection["1. ìˆ˜ì§‘"]
        IPA[IPA ë¡œê·¸] --> Filter[í•„í„°ë§]
        Filter --> |ë…¸ì´ì¦ˆ ì œê±°| Clean[ì •ì œëœ ë¡œê·¸]
    end
    
    subgraph Processing["2. ì²˜ë¦¬"]
        Clean --> Normalize[SQL ì •ê·œí™”]
        Normalize --> Template[í…œí”Œë¦¿í™”]
        Template --> Describe[ì„¤ëª… ìƒì„±<br/>LLM]
    end
    
    subgraph Indexing["3. ì¸ë±ì‹±"]
        Describe --> Embed[ì„ë² ë”©]
        Embed --> VDB[(Vector DB)]
        Describe --> ES[(Elasticsearch)]
    end
```

### 4.1 ë¡œê·¸ ìˆ˜ì§‘ & í•„í„°ë§

**ì œì™¸ ëŒ€ìƒ**:
- ì‹¤íŒ¨ ì¿¼ë¦¬ (error_count > 0)
- DDL/DML (CREATE, ALTER, DROP, INSERT, UPDATE, DELETE)
- ë°°ì¹˜ì„± ë‚´ë¶€ ì¿¼ë¦¬

**ìš°ì„  ì„ ì • ê¸°ì¤€**:
- ìì£¼ ì‹¤í–‰ë˜ëŠ” TOP-N ì¿¼ë¦¬ (exec_count ê¸°ì¤€)
- ë¶„ì„ì  ì¿¼ë¦¬ (ì§‘ê³„/ìœˆë„ìš° í•¨ìˆ˜ í¬í•¨)

### 4.2 SQL ì •ê·œí™”/í…œí”Œë¦¿í™”

ë¦¬í„°ëŸ´ íŒŒë¼ë¯¸í„°ë¥¼ placeholderë¡œ ì¹˜í™˜:

```sql
-- Before
SELECT * FROM MES_PRD_M11 WHERE lot_id = 'LOT001' AND create_dt > '2024-01-01'

-- After
SELECT * FROM MES_PRD_M11 WHERE lot_id = :1 AND create_dt > :2
```

### 4.3 ì„ë² ë”© ë¬¸ì„œ ìƒì„±

ê° ì¿¼ë¦¬ë‹¹ ìƒì„±ë˜ëŠ” ë¬¸ì„œ êµ¬ì¡°:

```json
{
  "sql_template": "SELECT ...",
  "tables": ["MES_PRD_M11", "MES_EQP_M11"],
  "columns": ["lot_id", "create_dt", "yield_rate"],
  "description": "M11 fabì˜ ì›”ë³„ ë¶ˆëŸ‰ë¥ ì„ ê³µì •ë³„ë¡œ ì§‘ê³„í•˜ëŠ” ì¿¼ë¦¬"
}
```

---

## 5. ëŸ°íƒ€ì„ ì»´í¬ë„ŒíŠ¸

### 5.1 API ì„œë²„

```python
# ì˜ˆì‹œ ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡°
POST /api/v1/query          # ìì—°ì–´ ì§ˆì˜ ì²˜ë¦¬
POST /api/v1/query/execute  # SQL ì§ì ‘ ì‹¤í–‰
GET  /api/v1/session/{id}   # ì„¸ì…˜ ìƒíƒœ ì¡°íšŒ
POST /api/v1/feedback       # í”¼ë“œë°± ì œì¶œ
```

### 5.2 LLM API í´ë¼ì´ì–¸íŠ¸

LangChain `ChatOpenAI`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ë‚´ OpenAI í˜¸í™˜ APIì— ì—°ê²°í•©ë‹ˆë‹¤:

```python
from langchain_openai import ChatOpenAI

chat_model = ChatOpenAI(
    base_url="http://internal-llm-server/v1",
    api_key="internal-api-key",
    model="internal-model-name",
    temperature=0.1,
    max_tokens=4096,
)
```

| ì„¤ì • | ê°’ (ì˜ˆì‹œ) |
|------|-----------|
| **ëª¨ë¸ëª…** | (ì‚¬ë‚´ ëª¨ë¸ëª…) |
| **Temperature** | 0.0 ~ 0.3 (SQL ìƒì„± ì‹œ ë‚®ê²Œ) |
| **Max Tokens** | 4096 |
| **ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸** | Agentë³„ ê°œë³„ ì„¤ì • (create_agentì˜ prompt íŒŒë¼ë¯¸í„°) |

### 5.3 SQL ì‹¤í–‰ ì—”ì§„

```mermaid
flowchart LR
    SQL[ìƒì„±ëœ SQL] --> Validate{ê²€ì¦}
    Validate -->|í†µê³¼| Sandbox[ìƒŒë“œë°•ìŠ¤ ì‹¤í–‰]
    Validate -->|ì‹¤íŒ¨| Reject[ê±°ë¶€]
    
    Sandbox --> |LIMIT ì ìš©| Execute[ì‹¤í–‰]
    Execute --> |Timeout ì ìš©| Result[ê²°ê³¼ ë°˜í™˜]
```

**ë³´ì•ˆ ì •ì±…**:
- SELECT ì¿¼ë¦¬ë§Œ í—ˆìš©
- í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ íŒ¨í„´ ê²€ì‚¬
- Row limit ê°•ì œ (ê¸°ë³¸ê°’: 1000)
- Timeout ê°•ì œ (ê¸°ë³¸ê°’: 30ì´ˆ)

### 5.4 Fab ID ì¡°íšŒ Tool

ì‚¬ìš©ìê°€ fab_id ì—†ì´ ì¡°íšŒ ì‹œë„í•  ë•Œ ìë™ìœ¼ë¡œ fab_idë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
LangChainì˜ `@tool` ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì˜ë©ë‹ˆë‹¤:

```python
from langchain.tools import tool

@tool
async def get_fab_id_from_eqp_id(eqp_id: str) -> str:
    """ì„¤ë¹„ IDì—ì„œ Fab IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
    ...

@tool
async def get_fab_id_from_lot_id(lot_id: str) -> str:
    """Lot IDì—ì„œ Fab IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
    ...

@tool
async def get_fab_id_from_product_id(product_id: str) -> str:
    """ì œí’ˆ IDì—ì„œ Fab IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
    ...
```

#### ì „ì²´ Tool ëª©ë¡

| Tool | ìš©ë„ | ì‚¬ìš© Agent |
|------|------|------------|
| `search_sql_templates` | SQL í…œí”Œë¦¿ ë²¡í„° ê²€ìƒ‰ | Query Agent |
| `search_schema_metadata` | ìŠ¤í‚¤ë§ˆ ë©”íƒ€ë°ì´í„° ê²€ìƒ‰ | Query Agent |
| `search_glossary` | ë¹„ì¦ˆë‹ˆìŠ¤ ìš©ì–´ ì‚¬ì „ ê²€ìƒ‰ | Question Agent |
| `get_fab_id_from_lot_id` | Lot ID â†’ Fab ID ì¡°íšŒ | Query Agent |
| `get_fab_id_from_eqp_id` | ì„¤ë¹„ ID â†’ Fab ID ì¡°íšŒ | Query Agent |
| `get_fab_id_from_product_id` | ì œí’ˆ ID â†’ Fab ID ì¡°íšŒ | Query Agent |
| `execute_sql` | SQL ì‹¤í–‰ | Answer Agent |
| `validate_sql` | SQL ê²€ì¦ (EXPLAIN) | Query Agent |

---

## 6. ì—ì´ì „íŠ¸ ì•„í‚¤í…ì²˜

### 6.0 LangChain create_agent ê¸°ë°˜ êµ¬í˜„

ëª¨ë“  ì—ì´ì „íŠ¸ëŠ” LangChain 1.xì˜ `create_agent` APIë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„ë©ë‹ˆë‹¤:

```mermaid
flowchart TB
    subgraph LangChainCore["LangChain Core"]
        CA["create_agent()"]
        Tools["@tool ë°ì½”ë ˆì´í„°"]
        State["TypedDict AgentState"]
        Middleware["Middleware"]
    end
    
    subgraph Agents["ì—ì´ì „íŠ¸"]
        QA[QuestionAgent]
        QueryA[QueryAgent]
        AA[AnswerAgent]
    end
    
    subgraph LLM["LLM"]
        ChatOpenAI["ChatOpenAI"]
    end
    
    QA --> CA
    QueryA --> CA
    AA --> CA
    
    CA --> Tools
    CA --> State
    CA --> Middleware
    CA --> ChatOpenAI
```

#### AgentState ì •ì˜

```python
from typing import TypedDict
from langchain.agents import AgentState

class Text2SQLState(AgentState):
    """Text2SQL ì—ì´ì „íŠ¸ ì „ì²´ ìƒíƒœ."""
    query_intent: dict | None
    sql: str | None
    result: dict | None
    needs_clarification: bool
    clarifying_question: str | None
    needs_stage2: bool
    stage2_reason: str | None
```

#### Tool ì •ì˜

```python
from langchain.tools import tool

@tool
async def search_sql_templates(query: str) -> list[dict]:
    """SQL í…œí”Œë¦¿ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤."""
    ...

@tool
async def get_fab_id_from_lot_id(lot_id: str) -> str:
    """Lot IDì—ì„œ Fab IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
    ...

@tool
async def execute_sql(sql: str) -> dict:
    """SQLì„ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    ...
```

### 6.0.1 ì—ì´ì „íŠ¸ íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
flowchart TB
    subgraph QuestionAgent["Question Agent"]
        Q1[ì§ˆì˜ ì •ì œ]
        Q2[íŒŒë¼ë¯¸í„° í™•ì¸]
        Q3[ì§ˆì˜ ë¶„ë¥˜]
        Q4[Clarifying ì§ˆë¬¸]
        
        Q1 --> Q2 --> Q3
        Q3 -->|ì •ë³´ ë¶€ì¡±| Q4
        Q4 --> Q2
    end
    
    subgraph QueryAgent["Query Agent"]
        QY1{ëª¨ë“œ ê²°ì •}
        
        subgraph Stage1Mode["1ë‹¨ê³„ ëª¨ë“œ"]
            S1A[í…œí”Œë¦¿ ê²€ìƒ‰]
            S1B[í…œí”Œë¦¿ ì„ íƒ]
            S1C[í…œí”Œë¦¿ ìˆ˜ì •]
        end
        
        subgraph Stage2Mode["2ë‹¨ê³„ ëª¨ë“œ"]
            S2A[ìŠ¤í‚¤ë§ˆ RAG]
            S2B[ì„¤ê³„ ë…¸íŠ¸ ìƒì„±]
            S2C[SQL ì´ˆì•ˆ ìƒì„±]
            S2D[Self-check]
        end
        
        QY1 -->|ìœ ì‚¬ë„ ì¶©ì¡±| Stage1Mode
        QY1 -->|ìœ ì‚¬ë„ ë¯¸ë‹¬| Stage2Mode
    end
    
    subgraph AnswerAgent["Answer Agent"]
        A1[ê²°ê³¼ ìš”ì•½]
        A2[ì„¤ëª… ìƒì„±]
        A3[ì‹œê°í™” ìŠ¤í™]
    end
    
    QuestionAgent --> QueryAgent
    QueryAgent --> AnswerAgent
```

### 6.1 Question Agent

**ì—­í• **: ì‚¬ìš©ì ìì—°ì–´ ì§ˆì˜ ì •ì œ ë° í•„ìˆ˜ ì •ë³´ ìˆ˜ì§‘

**ì§ˆì˜ ë¶„ë¥˜ ê¸°ì¤€**:

| ìœ í˜• | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| **ì¼ë°˜** | ì¿¼ë¦¬ íŠœë‹, ë¬¸ë²• ë³€ê²½ | "ì´ ì¿¼ë¦¬ ì†ë„ ê°œì„ í•´ì¤˜" |
| **ê²€ìƒ‰** | í…Œì´ë¸”/ì»¬ëŸ¼ ì°¾ê¸° | "ë¶ˆëŸ‰ë¥  ê´€ë ¨ í…Œì´ë¸” ë­ ìˆì–´?" |
| **ìƒì„±** | ì¡°ê±´ì— ë§ëŠ” SQL ìƒì„± | "ì§€ë‚œë‹¬ M11 ìˆ˜ìœ¨ ë³´ì—¬ì¤˜" |
| **ê°œì„ ** | SQL ì˜¤ë¥˜ ìˆ˜ì • | "ì´ ì¿¼ë¦¬ ì—ëŸ¬ ìˆ˜ì •í•´ì¤˜" |
| **ë³µí•©** | ìœ„ ìœ í˜•ì˜ ì¡°í•© | "A í…Œì´ë¸” ì°¾ì•„ì„œ B ì¡°íšŒí•´ì¤˜" |

**í•µì‹¬ ì›ì¹™**:
> âš ï¸ SQL ìƒì„±ì„ ìœ„í•œ í•„ìˆ˜ ì •ë³´ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ LLMì´ íŠ¹ì • ìƒí™©ì„ 'ê°€ì •'í•˜ì—¬ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ **ê¸ˆì§€**

### 6.2 Query Agent

#### 1ë‹¨ê³„ ëª¨ë“œ (ìœ ì‚¬ SQL ê¸°ë°˜)

```mermaid
sequenceDiagram
    participant U as User Intent
    participant R as Retrieval
    participant L as LLM
    participant V as Validator
    
    U->>R: ê²€ìƒ‰ìš© ì„¤ëª… í…ìŠ¤íŠ¸
    R->>R: ë²¡í„° ê²€ìƒ‰ (TOP-K)
    R->>R: í•˜ì´ë¸Œë¦¬ë“œ ë­í‚¹
    R->>L: í›„ë³´ í…œí”Œë¦¿ Nê°œ
    L->>L: ìµœì  í…œí”Œë¦¿ ì„ íƒ
    L->>L: Placeholder ë§¤í•‘
    L->>V: ìˆ˜ì •ëœ SQL
    V->>V: ì •ì  ë¶„ì„
    V-->>U: ì‹¤í–‰ ê°€ëŠ¥ SQL
```

**í•µì‹¬ í¬ì¸íŠ¸**:
- "ê²€ìƒ‰ìš© ì¿¼ë¦¬ ì„¤ëª… í…ìŠ¤íŠ¸" í’ˆì§ˆì´ í•µì‹¬ KPI
- ìœ ì‚¬ë„ ì„ê³„ê°’ ë¯¸ë‹¬ ì‹œ SQL ìƒì„± ì¤‘ë‹¨
- ìƒˆë¡œìš´ ì¡°ì¸/í…Œì´ë¸” ì¶”ê°€ëŠ” 2ë‹¨ê³„ë¡œ ìœ„ì„

#### 2ë‹¨ê³„ ëª¨ë“œ (ì „ë¬¸ê°€ ì‚¬ê³  ëª¨ì‚¬)

```mermaid
sequenceDiagram
    participant Q as Question Agent
    participant S as Schema RAG
    participant G as Query Generator
    participant V as Validator
    participant E as Executor
    
    Q->>S: êµ¬ì¡°í™”ëœ ì§ˆì˜ ì˜ë„
    S->>S: í›„ë³´ í…Œì´ë¸” ê²€ìƒ‰
    S->>S: ì»¬ëŸ¼ í›„ë³´ ì„ ì •
    S->>S: ì¡°ì¸ íŒ¨í„´ ì œì•ˆ
    S->>G: ë¶„ì„ê°€ ì„¤ê³„ ë…¸íŠ¸
    
    loop Self-check
        G->>G: ì´ˆì•ˆ SQL ìƒì„±
        G->>G: ìŠ¤í‚¤ë§ˆ ì¼ì¹˜ ê²€ì¦
        G->>G: ë…¼ë¦¬ì  ë²„ê·¸ ì ê²€
    end
    
    G->>V: ê²€ì¦ëœ SQL
    V->>V: EXPLAIN ì‹¤í–‰
    V->>V: ìœ„í—˜ë„ ìŠ¤ì½”ì–´ë§
    
    alt ìœ„í—˜ë„ ë†’ìŒ
        V->>V: ì¶•ì†Œ ë²„ì „ ì¿¼ë¦¬ ìƒì„±
    end
    
    V->>E: ìµœì¢… SQL
```

**ë¶„ì„ê°€ ì„¤ê³„ ë…¸íŠ¸ êµ¬ì¡°**:

```json
{
  "tables": [
    {"name": "MES_PRD_M11", "role": "ì£¼ í…Œì´ë¸”", "description": "..."}
  ],
  "join_plan": [
    {"from": "MES_PRD_M11", "to": "MES_EQP_M11", "key": "eqp_id", "type": "LEFT"}
  ],
  "filters": ["fab_id = 'M11'", "create_dt >= :start_date"],
  "aggregation": {"level": "daily", "columns": ["yield_rate"]}
}
```

### 6.3 Answer Agent

**ì—­í• **: SQL ê²°ê³¼ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ë³€í™˜

**ì¶œë ¥ í˜•ì‹**:
- ê²°ê³¼ í…Œì´ë¸” (Markdown)
- ìì—°ì–´ ìš”ì•½
- ì‹œê°í™” ìŠ¤í™ (ì„ íƒì )

```json
{
  "summary": "ì§€ë‚œ ë‹¬ M11 ë¼ì¸ì˜ ì¼ì¼ ë¶ˆëŸ‰ë¥ ì€ í‰ê·  2.3%ì˜€ìŠµë‹ˆë‹¤.",
  "visualization": {
    "type": "line_chart",
    "x_axis": "date",
    "y_axis": "defect_rate",
    "title": "M11 ì¼ì¼ ë¶ˆëŸ‰ë¥  ì¶”ì´"
  }
}
```

---

## 7. 1ë‹¨ê³„ â†’ 2ë‹¨ê³„ ì „í™˜ ë¡œì§

```mermaid
flowchart TD
    Start[1ë‹¨ê³„ ì‹œì‘] --> Search[ë²¡í„° ê²€ìƒ‰]
    Search --> CheckSim{ìœ ì‚¬ë„ ê²€ì‚¬}
    
    CheckSim -->|TOP-1 sim >= threshold| Select[í…œí”Œë¦¿ ì„ íƒ]
    CheckSim -->|TOP-1 sim < threshold| Stage2[2ë‹¨ê³„ ì „í™˜]
    
    Select --> TagCheck{íƒœê·¸ ê²€ì‚¬}
    TagCheck -->|ì¼ì¹˜| Execute[SQL ì‹¤í–‰]
    TagCheck -->|ë¶ˆì¼ì¹˜| Stage2
    
    Execute --> ResultCheck{ê²°ê³¼ ê²€ì¦}
    ResultCheck -->|ì„±ê³µ| Return[ê²°ê³¼ ë°˜í™˜]
    ResultCheck -->|ì‹¤íŒ¨| UserFeedback{ì‚¬ìš©ì í”¼ë“œë°±}
    
    UserFeedback -->|ë¶€ì •ì | Stage2
    UserFeedback -->|ê¸ì •ì | Return
    
    Stage2 --> Stage2Process[2ë‹¨ê³„ ì²˜ë¦¬]
```

**ì „í™˜ ì¡°ê±´**:

| ì¡°ê±´ ìœ í˜• | ìƒì„¸ |
|-----------|------|
| **ìœ ì‚¬ë„ ê¸°ë°˜** | TOP-1 cosine similarity < threshold (ê¸°ë³¸: 0.8) |
| **íƒœê·¸ ë¶ˆì¼ì¹˜** | í…œí”Œë¦¿ì˜ ì§‘ê³„ granularityê°€ ì§ˆì˜ ì˜ë„ì™€ ë‹¤ë¦„ |
| **ì‹¤í–‰ ì‹¤íŒ¨** | 1ë‹¨ê³„ í…œí”Œë¦¿ë“¤ë¡œ ìƒì„±ëœ SQL ì „ë¶€ ì‹¤íŒ¨ |
| **ì‚¬ìš©ì í”¼ë“œë°±** | ê²°ê³¼ê°€ ë§ì§€ ì•Šë‹¤ëŠ” ëª…ì‹œì  í”¼ë“œë°± |

---

## 8. ëª¨ë“ˆ êµ¬ì¡°

### 8.1 ì£¼ìš” ëª¨ë“ˆ

```mermaid
classDiagram
    class LogIngestor {
        +collect_logs()
        +filter_noise()
        +normalize_sql()
    }
    
    class SQLTemplateIndexer {
        +generate_description()
        +create_embedding()
        +index_template()
    }
    
    class SchemaKnowledgeBuilder {
        +snapshot_schema()
        +build_glossary()
        +index_metadata()
    }
    
    class RetrievalService {
        +search_templates()
        +search_schema()
        +hybrid_rank()
    }
    
    class QuestionAgentService {
        +refine_query()
        +collect_params()
        +classify_query()
    }
    
    class QueryAgentService {
        +select_template()
        +modify_template()
        +generate_sql()
    }
    
    class SQLEngineGateway {
        +validate_sql()
        +execute_sql()
        +explain_sql()
    }
    
    class AnswerAgentService {
        +summarize_result()
        +generate_viz_spec()
    }
    
    class FabIdResolver {
        +get_fab_from_eqp()
        +get_fab_from_lot()
    }
    
    LogIngestor --> SQLTemplateIndexer
    SQLTemplateIndexer --> RetrievalService
    SchemaKnowledgeBuilder --> RetrievalService
    QuestionAgentService --> QueryAgentService
    QueryAgentService --> RetrievalService
    QueryAgentService --> SQLEngineGateway
    QueryAgentService --> FabIdResolver
    QueryAgentService --> AnswerAgentService
```

### 8.2 ì¶”ìƒí™” ë ˆì´ì–´

```mermaid
classDiagram
    class VectorStore {
        <<abstract>>
        +search(query, top_k)
        +insert(documents)
        +delete(ids)
    }
    
    class MilvusStore {
        +search(query, top_k)
        +insert(documents)
        +delete(ids)
    }
    
    class DatabaseAdapter {
        <<abstract>>
        +execute(sql)
        +get_schema(table)
    }
    
    class OracleAdapter {
        +execute(sql)
        +get_schema(table)
    }
    
    class EmbeddingService {
        <<abstract>>
        +embed(text)
        +embed_batch(texts)
    }
    
    class OpenAIEmbedding {
        +embed(text)
        +embed_batch(texts)
    }
    
    VectorStore <|-- MilvusStore
    DatabaseAdapter <|-- OracleAdapter
    EmbeddingService <|-- OpenAIEmbedding
```

---

## 9. ì„¤ì • ë° íŒŒë¼ë¯¸í„°

### 9.1 ì‹œìŠ¤í…œ ì„¤ì •

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ì„¤ëª… |
|----------|--------|------|
| `SIMILARITY_THRESHOLD` | 0.8 | 1ë‹¨ê³„ ìœ ì‚¬ë„ ì„ê³„ê°’ |
| `TOP_K_TEMPLATES` | 5 | ê²€ìƒ‰í•  í…œí”Œë¦¿ ê°œìˆ˜ |
| `SQL_ROW_LIMIT` | 1000 | SQL ê²°ê³¼ row ìƒí•œ |
| `SQL_TIMEOUT_SEC` | 30 | SQL ì‹¤í–‰ timeout |
| `SESSION_TTL_MIN` | 60 | ì„¸ì…˜ ë§Œë£Œ ì‹œê°„ |
| `MAX_CLARIFY_TURNS` | 3 | Clarifying ì§ˆë¬¸ ìµœëŒ€ íšŸìˆ˜ |
| `MAX_SELF_CHECK_LOOPS` | 3 | Self-check ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ |

### 9.2 LLM ì„¤ì • (Agentë³„)

| Agent | Temperature | Max Tokens | íŠ¹ì´ì‚¬í•­ |
|-------|-------------|------------|----------|
| Question Agent | 0.3 | 1024 | íŒŒë¼ë¯¸í„° ì¶”ì¶œìš© |
| Query Agent (1ë‹¨ê³„) | 0.0 | 2048 | ì •í™•í•œ í…œí”Œë¦¿ ë§¤ì¹­ |
| Query Agent (2ë‹¨ê³„) | 0.1 | 4096 | SQL ìƒì„±ìš© |
| Answer Agent | 0.5 | 2048 | ìì—°ì–´ ìš”ì•½ìš© |

---

## 10. í™•ì¥ ë¡œë“œë§µ

### Phase 1: MVP
- [ ] 1ë‹¨ê³„ ì—ì´ì „íŠ¸ (ìœ ì‚¬ SQL ê¸°ë°˜)
- [ ] í•µì‹¬ ë°ì´í„° íŒŒì´í”„ë¼ì¸
- [ ] ê¸°ë³¸ API ì—”ë“œí¬ì¸íŠ¸
- [ ] ê¸°ë³¸ Fab ì§€ì› (Multi-Fab UNION ALL í…œí”Œë¦¿ í¬í•¨)

### Phase 2: ì•ˆì •í™”
- [ ] Fab ì¡°í•© ë™ì  ìƒì„± ì§€ì› (í…œí”Œë¦¿ì—ì„œ Fab í™•ì¥)
- [ ] Fab ID ìë™ ì¡°íšŒ Tool
- [ ] 2ë‹¨ê³„ ì—ì´ì „íŠ¸ (ì „ë¬¸ê°€ ëª¨ì‚¬)
- [ ] í”¼ë“œë°± ìˆ˜ì§‘

### Phase 3: ê³ ë„í™”
- [ ] ë³µí•© ì§ˆì˜ ì²˜ë¦¬
- [ ] ê²°ê³¼ ì‹œê°í™”
- [ ] ëª¨ë‹ˆí„°ë§/ëŒ€ì‹œë³´ë“œ
- [ ] LLM íŒŒì¸íŠœë‹

### Phase 4: í†µí•© ë° í™•ì¥
- [ ] Chainlit ì±„íŒ… UI ë„ì…
- [ ] Multiturn ëŒ€í™” ì§€ì›
- [ ] A2A í”„ë¡œí† ì½œ ì„œë²„ êµ¬í˜„
- [ ] A2A í´ë¼ì´ì–¸íŠ¸ ìƒ˜í”Œ ì œê³µ

---

## 11. Chainlit ì±„íŒ… UI

### 11.1 ê°œìš”

ì—ì´ì „íŠ¸ë¥¼ ë‹¨ë…ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë„ë¡ **Chainlit** ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›¹ ê¸°ë°˜ ì±„íŒ… UIë¥¼ ì œê³µí•©ë‹ˆë‹¤. Chainlitì€ Python ê¸°ë°˜ì˜ ì˜¤í”ˆì†ŒìŠ¤ í”„ë ˆì„ì›Œí¬ë¡œ, LangChain/LangGraphì™€ ì›í™œí•˜ê²Œ í†µí•©ë©ë‹ˆë‹¤.

```mermaid
flowchart LR
    subgraph ChainlitUI["Chainlit UI Layer"]
        WebUI[ì›¹ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤]
        Session[ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬]
        History[ëŒ€í™” íˆìŠ¤í† ë¦¬]
    end
    
    subgraph AgentPipeline["ì—ì´ì „íŠ¸ íŒŒì´í”„ë¼ì¸"]
        QA[Question Agent]
        QueryA[Query Agent]
        AA[Answer Agent]
    end
    
    subgraph Backend["ë°±ì—”ë“œ ì„œë¹„ìŠ¤"]
        RS[RetrievalService]
        DB[(Oracle DB)]
    end
    
    User([ì‚¬ìš©ì]) --> WebUI
    WebUI --> Session
    Session --> History
    WebUI --> QA
    QA --> QueryA
    QueryA --> AA
    QueryA --> RS
    QueryA --> DB
    AA --> WebUI
```

### 11.2 ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
src/text2sql/ui/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ app.py              # Chainlit ë©”ì¸ ì•± (ì—”íŠ¸ë¦¬í¬ì¸íŠ¸)
â”œâ”€â”€ handlers.py         # ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ë° ì½œë°±
â””â”€â”€ session_manager.py  # ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬

.chainlit/
â””â”€â”€ config.toml         # Chainlit UI ì„¤ì •
```

### 11.3 í•µì‹¬ êµ¬í˜„

#### Chainlit ì•± êµ¬ì¡°

```python
import chainlit as cl
from text2sql.agents import QuestionAgent, QueryAgent, AnswerAgent

@cl.on_chat_start
async def on_chat_start():
    """ì±„íŒ… ì„¸ì…˜ ì‹œì‘ ì‹œ ì´ˆê¸°í™”."""
    # ì—ì´ì „íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì„¸ì…˜ì— ì €ì¥
    cl.user_session.set("question_agent", QuestionAgent())
    cl.user_session.set("query_agent", QueryAgent())
    cl.user_session.set("answer_agent", AnswerAgent())
    cl.user_session.set("conversation_history", [])
    
    await cl.Message(
        content="ì•ˆë…•í•˜ì„¸ìš”! Text2SQL ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ë°ì´í„° ì¡°íšŒë¥¼ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
    ).send()

@cl.on_message
async def on_message(message: cl.Message):
    """ì‚¬ìš©ì ë©”ì‹œì§€ ì²˜ë¦¬."""
    # ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
    history = cl.user_session.get("conversation_history")
    history.append({"role": "user", "content": message.content})
    
    # ì—ì´ì „íŠ¸ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
    question_agent = cl.user_session.get("question_agent")
    query_agent = cl.user_session.get("query_agent")
    answer_agent = cl.user_session.get("answer_agent")
    
    # ì²˜ë¦¬ ê²°ê³¼ ë°˜í™˜
    response = await process_query(
        message.content,
        history,
        question_agent,
        query_agent,
        answer_agent
    )
    
    await cl.Message(content=response).send()
```

#### Multiturn ëŒ€í™” ìƒíƒœ ê´€ë¦¬

```python
class ConversationState:
    """Multiturn ëŒ€í™” ìƒíƒœ ê´€ë¦¬."""
    
    def __init__(self):
        self.history: list[dict] = []
        self.pending_clarification: bool = False
        self.context: dict = {}
    
    def add_turn(self, role: str, content: str):
        """ëŒ€í™” í„´ ì¶”ê°€."""
        self.history.append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        })
    
    def get_context_for_agent(self) -> dict:
        """ì—ì´ì „íŠ¸ì— ì „ë‹¬í•  ì»¨í…ìŠ¤íŠ¸ ìƒì„±."""
        return {
            "history": self.history[-10:],  # ìµœê·¼ 10í„´
            "pending_clarification": self.pending_clarification,
            **self.context
        }
```

### 11.4 Chainlit ì„¤ì •

`.chainlit/config.toml` íŒŒì¼:

```toml
[project]
enable_telemetry = false

[UI]
name = "Text2SQL Agent"
default_theme = "dark"
show_readme_as_default = false

[UI.theme]
primary_color = "#1E88E5"
background_color = "#1a1a2e"
font_family = "Inter, sans-serif"

[features]
prompt_playground = false
multi_modal = false
```

### 11.5 ì‹¤í–‰ ë°©ë²•

```bash
# ì˜ì¡´ì„± ì„¤ì¹˜
pip install chainlit>=1.0.0

# Chainlit ì•± ì‹¤í–‰
chainlit run src/text2sql/ui/app.py --port 8501

# ê°œë°œ ëª¨ë“œ (ìë™ ë¦¬ë¡œë“œ)
chainlit run src/text2sql/ui/app.py --port 8501 --watch
```

### 11.6 Multiturn ëŒ€í™” íë¦„

```mermaid
sequenceDiagram
    participant U as ì‚¬ìš©ì
    participant CL as Chainlit UI
    participant SM as SessionManager
    participant QA as Question Agent
    
    U->>CL: "M11 ìˆ˜ìœ¨ ë³´ì—¬ì¤˜"
    CL->>SM: ì„¸ì…˜ ìƒíƒœ ì¡°íšŒ
    SM->>CL: ëŒ€í™” íˆìŠ¤í† ë¦¬ ë°˜í™˜
    CL->>QA: ì§ˆì˜ + íˆìŠ¤í† ë¦¬ ì „ë‹¬
    QA->>CL: Clarifying ì§ˆë¬¸ í•„ìš”
    CL->>U: "ì–´ëŠ ê¸°ê°„ì˜ ìˆ˜ìœ¨ì„ ì¡°íšŒí• ê¹Œìš”?"
    
    U->>CL: "ì§€ë‚œ ì£¼"
    CL->>SM: ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    SM->>CL: ì—…ë°ì´íŠ¸ëœ íˆìŠ¤í† ë¦¬
    CL->>QA: í›„ì† ì§ˆì˜ ì²˜ë¦¬
    QA->>CL: SQL ìƒì„± ì™„ë£Œ
    CL->>U: ê²°ê³¼ í…Œì´ë¸” + ìš”ì•½ í‘œì‹œ
```

---

## 12. A2A í”„ë¡œí† ì½œ (Agent-to-Agent)

### 12.1 ê°œìš”

íƒ€ ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œì—ì„œ Text2SQL ì—ì´ì „íŠ¸ì™€ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ **Google A2A (Agent-to-Agent) í”„ë¡œí† ì½œ**ì„ ë„ì…í•©ë‹ˆë‹¤. A2AëŠ” ë‹¤ì–‘í•œ AI ì—ì´ì „íŠ¸ ê°„ì˜ í‘œì¤€í™”ëœ í†µì‹ ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ê°œë°©í˜• í”„ë¡œí† ì½œì…ë‹ˆë‹¤.

```mermaid
flowchart TB
    subgraph ExternalAgents["ì™¸ë¶€ ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ"]
        ClientA[ì—ì´ì „íŠ¸ A]
        ClientB[ì—ì´ì „íŠ¸ B]
        ClientC[A2A Client Sample]
    end
    
    subgraph Text2SQLServer["Text2SQL A2A Server"]
        AgentCard["Agent Card<br/>/.well-known/agent.json"]
        A2AEndpoint[A2A HTTP ì—”ë“œí¬ì¸íŠ¸]
        TaskHandler[Task Handler]
        Pipeline[ì—ì´ì „íŠ¸ íŒŒì´í”„ë¼ì¸]
    end
    
    ClientA -->|"1. GET Agent Card"| AgentCard
    ClientA -->|"2. POST /a2a/tasks"| A2AEndpoint
    ClientB -->|"POST /a2a/tasks"| A2AEndpoint
    ClientC -->|"POST /a2a/tasks"| A2AEndpoint
    
    A2AEndpoint --> TaskHandler
    TaskHandler --> Pipeline
    Pipeline -->|ê²°ê³¼| TaskHandler
    TaskHandler -->|JSON-RPC Response| ExternalAgents
```

### 12.2 A2A í”„ë¡œí† ì½œ í•µì‹¬ ê°œë…

| ê°œë… | ì„¤ëª… |
|------|------|
| **Agent Card** | ì—ì´ì „íŠ¸ì˜ ê¸°ëŠ¥, ìŠ¤í‚¬, ì—”ë“œí¬ì¸íŠ¸ URL, ì¸ì¦ ìš”êµ¬ì‚¬í•­ì„ ì„¤ëª…í•˜ëŠ” ë©”íƒ€ë°ì´í„° (`/.well-known/agent.json`) |
| **Task** | ì—ì´ì „íŠ¸ê°€ ìˆ˜í–‰í•˜ëŠ” ì‘ì—… ë‹¨ìœ„ (ìƒì„±/ì¡°íšŒ/ì·¨ì†Œ ê°€ëŠ¥) |
| **Message** | Task ë‚´ì—ì„œ êµí™˜ë˜ëŠ” ë©”ì‹œì§€ (ì‚¬ìš©ì ì…ë ¥, ì—ì´ì „íŠ¸ ì‘ë‹µ) |
| **Artifact** | Taskì˜ ê²°ê³¼ë¬¼ (ìƒì„±ëœ SQL, ì‹¤í–‰ ê²°ê³¼, ì‹œê°í™” ìŠ¤í™ ë“±) |
| **Skill** | ì—ì´ì „íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ ë‹¨ìœ„ |

### 12.3 A2A Server êµ¬í˜„

#### ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
src/text2sql/a2a/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ server.py           # A2A HTTP ì—”ë“œí¬ì¸íŠ¸ (FastAPI ë¼ìš°í„°)
â”œâ”€â”€ agent_card.py       # Agent Card ìƒì„± ë° ê´€ë¦¬
â”œâ”€â”€ task_handler.py     # Task ì²˜ë¦¬ ë¡œì§
â”œâ”€â”€ models.py           # A2A ë°ì´í„° ëª¨ë¸ (Pydantic)
â””â”€â”€ utils.py            # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
```

#### Agent Card ìŠ¤í‚¤ë§ˆ

`/.well-known/agent.json`:

```json
{
  "name": "Text2SQL Agent",
  "description": "í•˜ì´ë‹‰ìŠ¤ OLTP Mart ê¸°ë°˜ ìì—°ì–´ SQL ë³€í™˜ ì—ì´ì „íŠ¸",
  "version": "1.0.0",
  "protocol_version": "0.1",
  "url": "https://text2sql.hynix.internal",
  "authentication": {
    "schemes": ["bearer"]
  },
  "skills": [
    {
      "id": "text2sql",
      "name": "Text to SQL",
      "description": "ìì—°ì–´ ì§ˆì˜ë¥¼ SQLë¡œ ë³€í™˜í•˜ê³  ì‹¤í–‰ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤",
      "input_modes": ["text"],
      "output_modes": ["text", "data"]
    },
    {
      "id": "schema_search",
      "name": "Schema Search",
      "description": "í…Œì´ë¸”/ì»¬ëŸ¼ ìŠ¤í‚¤ë§ˆë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤",
      "input_modes": ["text"],
      "output_modes": ["text"]
    }
  ],
  "capabilities": {
    "streaming": false,
    "push_notifications": false
  }
}
```

#### A2A ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

```python
from fastapi import APIRouter, Request
from pydantic import BaseModel
from typing import Any

router = APIRouter(prefix="/a2a")

class TaskRequest(BaseModel):
    """A2A Task ìš”ì²­."""
    jsonrpc: str = "2.0"
    method: str
    params: dict[str, Any]
    id: str | int

class TaskResponse(BaseModel):
    """A2A Task ì‘ë‹µ."""
    jsonrpc: str = "2.0"
    result: dict[str, Any] | None = None
    error: dict[str, Any] | None = None
    id: str | int

@router.get("/.well-known/agent.json")
async def get_agent_card():
    """Agent Card ë°˜í™˜."""
    return generate_agent_card()

@router.post("/tasks")
async def handle_task(request: TaskRequest) -> TaskResponse:
    """A2A Task ì²˜ë¦¬."""
    if request.method == "tasks/create":
        return await create_task(request.params, request.id)
    elif request.method == "tasks/get":
        return await get_task(request.params, request.id)
    elif request.method == "tasks/cancel":
        return await cancel_task(request.params, request.id)
    else:
        return TaskResponse(
            id=request.id,
            error={"code": -32601, "message": "Method not found"}
        )

async def create_task(params: dict, request_id: str | int) -> TaskResponse:
    """ìƒˆ Task ìƒì„± ë° ì²˜ë¦¬."""
    task_id = generate_task_id()
    message = params.get("message", {})
    user_query = message.get("content", "")
    
    # Text2SQL íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
    result = await execute_text2sql_pipeline(user_query)
    
    return TaskResponse(
        id=request_id,
        result={
            "task_id": task_id,
            "status": "completed",
            "artifacts": [
                {
                    "type": "text",
                    "content": result.summary
                },
                {
                    "type": "data",
                    "content": {
                        "sql": result.sql,
                        "rows": result.rows,
                        "columns": result.columns
                    }
                }
            ]
        }
    )
```

### 12.4 A2A Client Sample

#### ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
samples/a2a_client/
â”œâ”€â”€ README.md           # ì‚¬ìš© ê°€ì´ë“œ
â”œâ”€â”€ requirements.txt    # ì˜ì¡´ì„±
â”œâ”€â”€ client.py           # A2A í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
â””â”€â”€ example.py          # ì‚¬ìš© ì˜ˆì œ
```

#### í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„

`samples/a2a_client/client.py`:

```python
import httpx
from typing import Any
from dataclasses import dataclass

@dataclass
class A2AClient:
    """A2A í”„ë¡œí† ì½œ í´ë¼ì´ì–¸íŠ¸."""
    
    base_url: str
    api_key: str | None = None
    
    async def get_agent_card(self) -> dict:
        """Agent Card ì¡°íšŒ."""
        async with httpx.AsyncClient() as client:
            response = await client.get(
                f"{self.base_url}/.well-known/agent.json"
            )
            response.raise_for_status()
            return response.json()
    
    async def create_task(
        self,
        message: str,
        skill_id: str = "text2sql"
    ) -> dict:
        """ìƒˆ Task ìƒì„±."""
        request = {
            "jsonrpc": "2.0",
            "method": "tasks/create",
            "params": {
                "skill_id": skill_id,
                "message": {
                    "role": "user",
                    "content": message
                }
            },
            "id": self._generate_request_id()
        }
        
        headers = {}
        if self.api_key:
            headers["Authorization"] = f"Bearer {self.api_key}"
        
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.base_url}/a2a/tasks",
                json=request,
                headers=headers
            )
            response.raise_for_status()
            return response.json()
    
    async def get_task(self, task_id: str) -> dict:
        """Task ìƒíƒœ ì¡°íšŒ."""
        request = {
            "jsonrpc": "2.0",
            "method": "tasks/get",
            "params": {"task_id": task_id},
            "id": self._generate_request_id()
        }
        
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.base_url}/a2a/tasks",
                json=request
            )
            return response.json()
    
    def _generate_request_id(self) -> str:
        import uuid
        return str(uuid.uuid4())
```

#### ì‚¬ìš© ì˜ˆì œ

`samples/a2a_client/example.py`:

```python
import asyncio
from client import A2AClient

async def main():
    # í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    client = A2AClient(
        base_url="http://localhost:8080",
        api_key="your-api-key"
    )
    
    # 1. Agent Card ì¡°íšŒ
    agent_card = await client.get_agent_card()
    print(f"Agent: {agent_card['name']}")
    print(f"Skills: {[s['id'] for s in agent_card['skills']]}")
    
    # 2. Text2SQL Task ìƒì„±
    result = await client.create_task(
        message="ì§€ë‚œ ì£¼ M11 fabì˜ ì¼ë³„ ìˆ˜ìœ¨ì„ ë³´ì—¬ì¤˜"
    )
    
    if result.get("result"):
        task_result = result["result"]
        print(f"Task ID: {task_result['task_id']}")
        print(f"Status: {task_result['status']}")
        
        for artifact in task_result.get("artifacts", []):
            if artifact["type"] == "text":
                print(f"Summary: {artifact['content']}")
            elif artifact["type"] == "data":
                print(f"SQL: {artifact['content']['sql']}")
    else:
        print(f"Error: {result.get('error')}")

if __name__ == "__main__":
    asyncio.run(main())
```

### 12.5 A2A í†µì‹  íë¦„

```mermaid
sequenceDiagram
    participant EA as ì™¸ë¶€ ì—ì´ì „íŠ¸
    participant A2A as A2A Server
    participant TH as Task Handler
    participant QA as Question Agent
    participant QueryA as Query Agent
    participant AA as Answer Agent
    
    EA->>A2A: GET /.well-known/agent.json
    A2A-->>EA: Agent Card ë°˜í™˜
    
    EA->>A2A: POST /a2a/tasks (tasks/create)
    A2A->>TH: Task ìƒì„±
    TH->>QA: ì§ˆì˜ ì •ì œ
    QA->>QueryA: ì˜ë„ ì „ë‹¬
    QueryA->>QueryA: SQL ìƒì„±
    QueryA->>AA: SQL + ì‹¤í–‰ ê²°ê³¼
    AA->>TH: ìš”ì•½ ìƒì„±
    TH->>A2A: Artifacts ìƒì„±
    A2A-->>EA: Task ê²°ê³¼ (JSON-RPC Response)
```

### 12.6 ë³´ì•ˆ ë° ì¸ì¦

| í•­ëª© | ì„¤ì • |
|------|------|
| **ì¸ì¦ ë°©ì‹** | Bearer Token (API Key) |
| **Rate Limiting** | 100 requests/minute per client |
| **Timeout** | Task ìƒì„±: 60ì´ˆ, Task ì¡°íšŒ: 5ì´ˆ |
| **CORS** | í—ˆìš©ëœ Originë§Œ ì ‘ê·¼ ê°€ëŠ¥ |

### 12.7 A2A ì„¤ì • íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ì„¤ëª… |
|----------|--------|------|
| `A2A_ENABLED` | true | A2A ì—”ë“œí¬ì¸íŠ¸ í™œì„±í™” ì—¬ë¶€ |
| `A2A_RATE_LIMIT` | 100 | ë¶„ë‹¹ ìµœëŒ€ ìš”ì²­ ìˆ˜ |
| `A2A_TASK_TIMEOUT_SEC` | 60 | Task ì²˜ë¦¬ íƒ€ì„ì•„ì›ƒ |
| `A2A_MAX_HISTORY` | 100 | ìœ ì§€í•  ìµœëŒ€ Task íˆìŠ¤í† ë¦¬ ìˆ˜ |

---

## ë¶€ë¡: ìš©ì–´ ì •ì˜

| ìš©ì–´ | ì •ì˜ |
|------|------|
| **Fab** | Fabricationì˜ ì•½ì, ë°˜ë„ì²´ ìƒì‚° ë¼ì¸ ë‹¨ìœ„ |
| **Site ID** | ìƒì‚° ê³µì¥ ìœ„ì¹˜ ì‹ë³„ì (IC: ì´ì²œ, CJ: ì²­ì£¼, WX: ìš°ì‹œ) |
| **Fab ID** | Fab ë‹¨ìœ„ ì‹ë³„ì, Siteë³„ë¡œ êµ¬ë¶„ë¨ (ì˜ˆ: M10, M11, C2) |
| **fab_ids** | ë³µìˆ˜ Fab ì§€ì›ì„ ìœ„í•œ Fab ID ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: ["M10", "M11", "M14"]) |
| **ê³µì • Suffix** | Site IDì™€ ê³µì •ëª…ì„ ì¡°í•©í•œ í…Œì´ë¸” ì ‘ë¯¸ì‚¬ (ì˜ˆ: ICWT, CJPNT) |
| **Multi-Fab UNION ALL** | ë™ì¼ êµ¬ì¡°ì˜ SQLì„ ì—¬ëŸ¬ Fab í…Œì´ë¸”ì—ì„œ UNION ALLë¡œ ê²°í•©í•˜ëŠ” íŒ¨í„´ |
| **IPA** | SQL ì‹¤í–‰ ë¡œê·¸ ìˆ˜ì§‘ ì‹œìŠ¤í…œ |
| **Template** | ë¦¬í„°ëŸ´ ê°’ì´ placeholderë¡œ ì¹˜í™˜ëœ SQL |
| **Hybrid Search** | ë²¡í„° ìœ ì‚¬ë„ + í‚¤ì›Œë“œ ë§¤ì¹­ì„ ì¡°í•©í•œ ê²€ìƒ‰ |
| **Self-check** | LLMì´ ìì‹ ì˜ ì¶œë ¥ì„ ê²€ì¦í•˜ëŠ” ê³¼ì • |
| **í‘œì¤€ ë‹¨ì–´ì‚¬ì „** | OLTP Martì˜ ë¬¼ë¦¬ëª…/ë¬¼ë¦¬ì˜ë¯¸/ì„¤ëª…ì„ ì •ì˜í•œ CSV í˜•íƒœ ì‚¬ì „ |
| **Chainlit** | Python ê¸°ë°˜ ëŒ€í™”í˜• AI ì• í”Œë¦¬ì¼€ì´ì…˜ UI í”„ë ˆì„ì›Œí¬ |
| **Multiturn** | ì—¬ëŸ¬ í„´ì— ê±¸ì³ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ ì§€í•˜ëŠ” ëŒ€í™” ë°©ì‹ |
| **A2A** | Agent-to-Agent, Googleì´ ì œì•ˆí•œ ì—ì´ì „íŠ¸ ê°„ í†µì‹  í‘œì¤€ í”„ë¡œí† ì½œ |
| **Agent Card** | A2A í”„ë¡œí† ì½œì—ì„œ ì—ì´ì „íŠ¸ì˜ ê¸°ëŠ¥ê³¼ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì„¤ëª…í•˜ëŠ” ë©”íƒ€ë°ì´í„° |
| **Task** | A2A í”„ë¡œí† ì½œì—ì„œ ì—ì´ì „íŠ¸ê°€ ìˆ˜í–‰í•˜ëŠ” ì‘ì—… ë‹¨ìœ„ |
| **Artifact** | A2A Taskì˜ ê²°ê³¼ë¬¼ (SQL, ë°ì´í„°, ì‹œê°í™” ìŠ¤í™ ë“±) |
| **Skill** | A2A í”„ë¡œí† ì½œì—ì„œ ì—ì´ì „íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ ë‹¨ìœ„ |

